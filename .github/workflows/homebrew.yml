name: Update Homebrew Tap

on:
  release:
    types: [published]

jobs:
  build-bottles:
    strategy:
      matrix:
        include:
          - os: macos-13  # Intel Mac
            arch: x86_64
            bottle_tag: ventura
          - os: macos-14  # Apple Silicon
            arch: arm64
            bottle_tag: arm64_sonoma
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build release
        run: cargo build --release

      - name: Create bottle
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix
          BOTTLE_NAME="micropub-${VERSION}.${{ matrix.bottle_tag }}.bottle.tar.gz"

          cd target/release
          tar czf "../../${BOTTLE_NAME}" micropub
          cd ../..

          # Calculate SHA256
          SHA256=$(shasum -a 256 "${BOTTLE_NAME}" | awk '{print $1}')
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT
          echo "bottle_name=${BOTTLE_NAME}" >> $GITHUB_OUTPUT
        id: bottle

      - name: Upload bottle
        uses: actions/upload-artifact@v3
        with:
          name: bottle-${{ matrix.arch }}
          path: ${{ steps.bottle.outputs.bottle_name }}

      - name: Save bottle info
        run: |
          echo "${{ matrix.bottle_tag }}:${{ steps.bottle.outputs.sha256 }}" > bottle-${{ matrix.arch }}.txt

      - name: Upload bottle info
        uses: actions/upload-artifact@v3
        with:
          name: bottle-info-${{ matrix.arch }}
          path: bottle-${{ matrix.arch }}.txt

  update-formula:
    needs: build-bottles
    runs-on: ubuntu-latest
    steps:
      - name: Get release version
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Download source tarball and calculate SHA256
        id: source
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          URL="https://github.com/harperreed/micropub/archive/refs/tags/v${VERSION}.tar.gz"
          curl -L -o source.tar.gz "${URL}"
          SHA256=$(shasum -a 256 source.tar.gz | awk '{print $1}')
          echo "sha256=${SHA256}" >> $GITHUB_OUTPUT

      - name: Download bottle info
        uses: actions/download-artifact@v3
        with:
          path: bottle-info

      - name: Read bottle SHA256s
        id: bottles
        run: |
          X86_64_INFO=$(cat bottle-info/bottle-info-x86_64/bottle-x86_64.txt)
          ARM64_INFO=$(cat bottle-info/bottle-info-arm64/bottle-arm64.txt)

          X86_64_TAG=$(echo "$X86_64_INFO" | cut -d':' -f1)
          X86_64_SHA=$(echo "$X86_64_INFO" | cut -d':' -f2)

          ARM64_TAG=$(echo "$ARM64_INFO" | cut -d':' -f1)
          ARM64_SHA=$(echo "$ARM64_INFO" | cut -d':' -f2)

          echo "x86_64_tag=${X86_64_TAG}" >> $GITHUB_OUTPUT
          echo "x86_64_sha=${X86_64_SHA}" >> $GITHUB_OUTPUT
          echo "arm64_tag=${ARM64_TAG}" >> $GITHUB_OUTPUT
          echo "arm64_sha=${ARM64_SHA}" >> $GITHUB_OUTPUT

      - name: Generate formula
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SOURCE_SHA="${{ steps.source.outputs.sha256 }}"
          X86_64_TAG="${{ steps.bottles.outputs.x86_64_tag }}"
          X86_64_SHA="${{ steps.bottles.outputs.x86_64_sha }}"
          ARM64_TAG="${{ steps.bottles.outputs.arm64_tag }}"
          ARM64_SHA="${{ steps.bottles.outputs.arm64_sha }}"

          cat > micropub.rb << EOF
          class Micropub < Formula
            desc "Ultra-compliant Micropub CLI with MCP server support"
            homepage "https://github.com/harperreed/micropub"
            url "https://github.com/harperreed/micropub/archive/refs/tags/v${VERSION}.tar.gz"
            sha256 "${SOURCE_SHA}"
            license "MIT"

            depends_on "rust" => :build

            bottle do
              root_url "https://github.com/harperreed/micropub/releases/download/v${VERSION}"
              sha256 cellar: :any_skip_relocation, ${ARM64_TAG}: "${ARM64_SHA}"
              sha256 cellar: :any_skip_relocation, ${X86_64_TAG}: "${X86_64_SHA}"
            end

            def install
              system "cargo", "install", *std_cargo_args
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/micropub --version")
            end
          end
          EOF

      - name: Checkout homebrew-tap
        uses: actions/checkout@v3
        with:
          repository: harperreed/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula in tap
        run: |
          mkdir -p homebrew-tap/Formula
          cp micropub.rb homebrew-tap/Formula/micropub.rb

      - name: Commit and push formula
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/micropub.rb
          git commit -m "Update micropub to ${{ steps.version.outputs.version }}"
          git push

      - name: Upload bottles to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          files: |
            bottle-info/bottle-x86_64/*
            bottle-info/bottle-arm64/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
